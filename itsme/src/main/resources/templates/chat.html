<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<link
	href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
	rel="stylesheet" />
<link href="starboot/css/chatStyle.css" rel="stylesheet" />
</head>
<body>

	<div class="container">
		<div class="row clearfix">
			<div class="col-lg-12">
				<div class="card chat-app">
					<div id="plist" class="people-list">
						<div class="input-group">
							<div class="input-group-prepend">
								<span class="input-group-text"><i class="fa fa-search"></i></span>
							</div>
							<input type="text" class="form-control" placeholder="Search...">
						</div>
						
						
						<ul id="online-user" class="list-unstyled chat-list mt-2 mb-0">

							<!-- master status -->
							<li class="clearfix" onclick="activeToggle(this)" id="master"><img
								src="https://bootdey.com/img/Content/avatar/avatar1.png"
								alt="avatar">
							<div class="about">
									<div id="master" class="name">master</div>
									<div id="master-status" class="status">
										<i id="master-status-icon" class="fa fa-circle offline"> </i>
										<span id="master-status-content">offline </span>
									</div>
								</div></li>
						</ul>
					</div>

					<!-- chatting section -->
					<div class="chat">
						<div class="chat-header clearfix">
							<div class="row">
								<div class="col-lg-6">
									<a href="javascript:void(0);" data-toggle="modal"
										data-target="#view_info"> <img
										src="https://bootdey.com/img/Content/avatar/avatar2.png"
										alt="avatar">
									</a>
									<div class="chat-about">
										<span class="m-b-0" th:text="${session.sessionId}"></span>
									</div>
								</div>
								
							</div>
						</div>
						<div class="chat-history">
							<ul style="overflow: scroll; height: 662px;" id="chat-content"
								class="m-b-0">

							</ul>
						</div>
						<div class="chat-message clearfix">
							<div class="input-group mb-0">
								<div class="input-group-prepend">
									<input id="msg" type="text"
										onkeydown="if(event.keyCode==13){send()}" class="form-control"
										placeholder="Enter text here...">
									<button id="button-send" type="button" class="input-group-text">
										<i class="fa fa-send"></i>
									</button>
									<button id="disconn" class="form-control float-right">disconnect</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<script type="text/javascript" th:inline="javascript">
		 var receiverId;
	     var preOnlineList;
	     var masterStatusContent;  
   		 var preMasterStatus;
	   	 var masterStatus;
		
         document.querySelector("#disconn").addEventListener("click", (e) => {
        	location.href = "/";
            onClose(e);
         })
         
         document.querySelector("#button-send").addEventListener("click", (e) => {
	        	send();
         });

         const websocket = new WebSocket("ws://localhost:8080/ws/chat");
	         websocket.onmessage = onMessage;
	         websocket.onopen = onOpen;
	         websocket.onclose = onClose;

         // send a message
         function send(){
            var message = document.getElementById("msg").value;
			// don't send when content is empty
            if(message != "") {			
	        	 let msg = {
	        		 'receiverId' : receiverId,
	        		 'message' : message
	        	 }
	        	 
	             if(message != null) {
	             	websocket.send(JSON.stringify(msg));
	             }
	             document.getElementById("msg").value = '';
	         }
         }
         
         //on exit chat room
         function onClose(evt) {
        	 console.log("close event : " + evt);
         }
         
         //on entering chat room
         function onOpen(evt) {
        	 console.log("open event : " + evt);
         }
	
         // on message controller
         function onMessage(msg) {
        	 masterStatusContent = document.getElementById('master-status-content');     
        	 preMasterStatus = masterStatusContent.innerHTML;
        	 
        	 console.log('msg.data >>> ', msg.data);
        	 var data = JSON.parse(msg.data);
        	 
        	 var onlineList = data.onlineList;
        	 console.log('onlineList >>>> ', onlineList);
        	 
             var senderId = data.senderId;
             console.log('senderId >>> ', senderId)
             var receiverId = data.receiverId;
             console.log('receiverId >>> ', receiverId)
             var message = data.message;
             console.log('message >>> ', message)
             var time = data.time;
             console.log('time >>> ', time)
             masterStatus = data.masterStatus;
             console.log('preMasterStatus >>> ', preMasterStatus)
             console.log('masterStatus >>> ', masterStatus)
             var newOne = data.newOne;
             console.log('newOne >>> ', newOne);
             var outOne = data.outOne;
             console.log('outOne >>> ', outOne);
             
             // when user login
             // first login master -> get all onlined user list
             if(newOne != null) {
            	 console.log("new One is not null");
				if(receiverId == 'master' && newOne == "master") {
					getOnlineList(onlineList);
				} else if(receiverId == "master" && newOne != "master") {
					console.log("new one login >>>> " , newOne);
					insertOnlineList(newOne);
				}
             }
             
             // when user disconnect
             if(outOne != null && receiverId == 'master') {
            	 console.log("user disconnect >>> ", outOne);
            	 deleteOnlieList(outOne);
             }

			 // insert a message into a chatting section
             var chatContent =  document.querySelector("#chat-content");
             if(senderId == receiverId) {
            	// insert a message into chat content to myself
                 var li = document.createElement('li');
                 li.classList.add('clearfix');
                 li.classList.add('float-right');
                 var str = "<div class='message-data'>";
                 str += "<span class='message-data-time'>";
                 str += time + "</span></div>";
                 str += "<div class='message my-message'>";
                 str += message + "</div></li>";
              
                 li.innerHTML = str;
                 chatContent.appendChild(li);
             } else {
				// insert a message into chat content to other
	            var li = document.createElement('li');
	            li.classList.add('clearfix');
	            var str =senderId + "<div class='message-data'>";
	            str += "<span class='message-data-time'>";
	            str += time + "</span></div>";
	            str += "<div class='message other-message'>";
	            str += message + "</div></li>";
	         
	            li.innerHTML = str;
	            chatContent.appendChild(li);
             }
	         
             // update master status
             updateMasterStatus();
             // scroll down
             scrollDown();
       	 }
         
         // onclick onlined user icon
         function activeToggle(element){
        	 if(!element.classList.contains('active')){
        		 element.classList.add('active');
        	 } else {
        		 element.classList.remove('active');
        	 };
        	 var preReceiverId = receiverId;
        	 receiverId = element.childNodes[2].childNodes[1].innerHTML;
        	 console.log('reciverId >>> ', receiverId);
        	 console.log('preReceiverId >>> ', preReceiverId);
			
        	 if(receiverId != preReceiverId && preReceiverId != null)
	        	 document.getElementById(preReceiverId).classList.remove('active');
        	 
        	 divideChatSection(receiverId);
        	 
         }
         
	      // insert all users into online list
         function getOnlineList(onlineList){
	        var onlineUser =  document.querySelector("#online-user");
        	onlineUser.innerHTML = "";
			onlineList.forEach(user => {
	        	insertOnlineList(user);
			});        	 
         }
         
         // insert online user list
         function insertOnlineList(user) {
	       	    var onlineUser =  document.querySelector("#online-user");
 	        
        		var li = document.createElement('li');
	            li.classList.add('clearfix');
	            li.setAttribute('onclick', 'activeToggle(this)');
	            li.setAttribute('id', user);
	            var str ='<img src="https://bootdey.com/img/Content/avatar/avatar1.png" alt="avatar">' + " ";
	            str += '<div class="about">' + " ";
	            str += '<div class="name">' + user + '</div>';
	            str += '<div class="status">';
	            str += '<i id="master-status-icon" class="fa fa-circle online"></i>';
	            str += '<span id=master-status-content>online</span></div>';
				
	            li.innerHTML = str;
	            onlineUser.appendChild(li);
         }
         
         // delete outOne from onlineList
         function deleteOnlieList(outOne) {
	     	var element =  document.getElementById(outOne);
			element.parentNode.removeChild(element);
         }
         
         // insert division of receiver
         function divideChatSection(receiverId){
        	  var div = document.createElement('div');
              div.classList.add('clearfix');
              var str = receiverId + '님과의 대화 시작 ';
              str += "<hr>";
           
              div.innerHTML = str;
              var chatContent =  document.querySelector("#chat-content");
              chatContent.appendChild(div);
              
              scrollDown();
         }
         
         // update master status
         function updateMasterStatus(){
        	 if(preMasterStatus != masterStatus) {
 				var icon = document.getElementById('master-status-icon');
 	            
 				if(masterStatus == "online") {
 	            	 icon.classList.remove('offline');
 	            	 icon.classList.add('online');
 	             } else {
 	            	 icon.classList.remove('online');
 	            	 icon.classList.add('offline');
 	             }
 				masterStatusContent.innerHTML = masterStatus;
 				console.log('<<< updated master status >>> now : ', masterStatus);
 			}
         }
         
         
         // scroll down event
         function scrollDown() {
             var chatContent =  document.querySelector("#chat-content");
             chatContent.scrollTop = chatContent.scrollHeight;
         }
         
         
	</script>
</body>
</html>