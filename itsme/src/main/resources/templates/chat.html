<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<link
	href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
	<link href="starboot/css/chatStyle.css" rel="stylesheet" />
</head>
<body>

	<div class="container">
		<div class="row clearfix">
			<div class="col-lg-12">
				<div class="card chat-app">
					<div id="plist" class="people-list">
						<div class="input-group">
							<div class="input-group-prepend">
								<span class="input-group-text"><i class="fa fa-search"></i></span>
							</div>
							<input type="text" class="form-control" placeholder="Search...">
						</div>
						<ul class="list-unstyled chat-list mt-2 mb-0">
						
						<!-- master status -->
							<li class="clearfix" onclick="activeToggle(this)">
							<img src="https://bootdey.com/img/Content/avatar/avatar1.png" alt="avatar">
								<div class="about">
									<div class="name">Master</div>
									<div id="master" class="status">
										<i id="master-status-icon" class="fa fa-circle offline"></i> 
										<span id = master-status-content>offline</span>
									</div>
								</div></li>
								
							<!--
							<li class="clearfix active"><img
								src="https://bootdey.com/img/Content/avatar/avatar2.png"
								alt="avatar">
								<div class="about">
									<div class="name">Aiden Chavez</div>
									<div class="status">
										<i class="fa fa-circle online"></i> online
									</div>
								</div></li>
							<li class="clearfix"><img src="https://bootdey.com/img/Content/avatar/avatar3.png" alt="avatar">
								<div class="about">
									<div class="name">Mike Thomas</div>
									<div class="status">
										<i class="fa fa-circle online"></i> online
									</div>
								</div></li>
							<li class="clearfix"><img
								src="https://bootdey.com/img/Content/avatar/avatar7.png"
								alt="avatar">
								<div class="about">
									<div class="name">Christian Kelly</div>
									<div class="status">
										<i class="fa fa-circle offline"></i> left 10 hours ago
									</div>
								</div></li>
							<li class="clearfix"><img
								src="https://bootdey.com/img/Content/avatar/avatar8.png"
								alt="avatar">
								<div class="about">
									<div class="name">Monica Ward</div>
									<div class="status">
										<i class="fa fa-circle online"></i> online
									</div>
								</div></li>
							<li class="clearfix"><img
								src="https://bootdey.com/img/Content/avatar/avatar3.png"
								alt="avatar">
								<div class="about">
									<div class="name">Dean Henry</div>
									<div class="status">
										<i class="fa fa-circle offline"></i> offline since Oct 28
									</div>
								</div></li>
								-->
						</ul>
					</div>
					
					<!-- chatting section -->
					<div class="chat">
						<div class="chat-header clearfix">
							<div class="row">
								<div class="col-lg-6">
									<a href="javascript:void(0);" data-toggle="modal"
										data-target="#view_info"> <img
										src="https://bootdey.com/img/Content/avatar/avatar2.png"
										alt="avatar">
									</a>
									<div class="chat-about">
										<h6 class="m-b-0">Aiden Chavez</h6>
										<small>Last seen: 2 hours ago</small>
									</div>
								</div>
								<div class="col-lg-6 hidden-sm text-right">
									<a href="javascript:void(0);" class="btn btn-outline-secondary"><i
										class="fa fa-camera"></i></a> <a href="javascript:void(0);"
										class="btn btn-outline-primary"><i class="fa fa-image"></i></a>
									<a href="javascript:void(0);" class="btn btn-outline-info"><i
										class="fa fa-cogs"></i></a> <a href="javascript:void(0);"
										class="btn btn-outline-warning"><i class="fa fa-question"></i></a>
								</div>
							</div>
						</div>
						<div class="chat-history">
							<ul style="overflow:scroll; height: 662px;" id="chat-content" class="m-b-0">
								
							</ul>
						</div>
						<div class="chat-message clearfix">
							<div class="input-group mb-0">
								<div class="input-group-prepend">
									<input id="msg" type="text" onkeydown="if(event.keyCode==13){send()}" class="form-control" placeholder="Enter text here...">
									<button id="button-send" type="button" class="input-group-text"><i class="fa fa-send"></i></button>
									<button id="disconn"  class="form-control float-right" >disconnect</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<script type="text/javascript" th:inline="javascript">
	
         document.querySelector("#disconn").addEventListener("click", (e) => {
        	location.href = "/";
            onClose(e);
         })
         
         document.querySelector("#button-send").addEventListener("click", (e) => {
             send();
         });

         const websocket = new WebSocket("ws://localhost:8080/ws/chat");
	         websocket.onmessage = onMessage;
	         websocket.onopen = onOpen;
	         websocket.onclose = onClose;

         // send a message
         function send(){
             let msg = document.getElementById("msg").value;
             if(msg != null) {
             	websocket.send(msg);
             }
             document.getElementById("msg").value = '';
         }
         
         //채팅창에서 나갔을 때
         function onClose(evt) {
        	 console.log("close event : " + evt);
         }
         
         //채팅창에 들어왔을 때
         function onOpen(evt) {
        	 console.log("open event : " + evt);
         }

         function onMessage(msg) {
        	 console.log("onMessage : " + msg);
             var data = msg.data;
             var senderId = null;
             var message = null;
             var arr = data.split("&");
             
           	 senderId = arr[0];
             message = arr[1];
             time = arr[2];
             masterStatus = arr[3];
             myself = arr[4];
             
			 var preStatus = document.getElementById('master-status-content').innerHTML;             
            
			 console.log('현재 마스터 상태 : >>> ',masterStatus );
			 console.log('현재 html 상태 : >>> ',preStatus );
			 
			// update master status
			if(preStatus != masterStatus) {
				var icon = document.getElementById('master-status-icon');
	            
				if(preStatus == "online") {
	            	 icon.classList.remove('online');
	            	 icon.classList.add('offline');
	             } else {
	            	 icon.classList.remove('offline');
	            	 icon.classList.add('online');
	             }
				document.getElementById('master-status-content').innerHTML = masterStatus;
			}
             
             if(myself == 'true') {
            	// insert a message into chat content to myself
                 var li = document.createElement('li');
                 li.classList.add('clearfix');
                 li.classList.add('float-right');
                 var str = "<div class='message-data'>";
                 str += "<span class='message-data-time'>";
                 str += time + "</span></div>";
                 str += "<div class='message my-message'>";
                 str += message + "</div></li>";
              
                 li.innerHTML = str;
                 var chatContent =  document.querySelector("#chat-content");
                 chatContent.appendChild(li);
             } else {
				// insert a message into chat content to other
	            var li = document.createElement('li');
	            li.classList.add('clearfix');
	            var str = "<div class='message-data'>";
	            str += "<span class='message-data-time'>";
	            str += time + "</span></div>";
	            str += "<div class='message other-message'>";
	            str += message + "</div></li>";
	         
	            li.innerHTML = str;
	            var chatContent =  document.querySelector("#chat-content");
	            chatContent.appendChild(li);
             }
            // scroll down
            chatContent.scrollTop = chatContent.scrollHeight;
         }
         
         
         function activeToggle(element){
        	 if(!element.classList.contains('active')){
        		 element.classList.add('active');
        	 } else {
        		 element.classList.remove('active');
        	 };
        	 
         }
	</script>
</body>
</html>